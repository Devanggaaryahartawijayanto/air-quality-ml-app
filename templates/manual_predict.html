{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12 text-center">
        <h1 class="display-6 fw-bold text-dark">Prediksi Manual</h1>
        <p class="text-muted text-uppercase small letter-spacing-2">Input parameter kualitas udara secara manual</p>
    </div>
</div>

<div class="row justify-content-center">
    <!-- Input Form -->
    <div class="col-md-5">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold">Parameter Input</h6>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="fetchLiveData()">
                    <i class="bi bi-cloud-download"></i> Isi Data Terkini (Jakarta)
                </button>
            </div>
            <div class="card-body">
                <form method="POST" action="/manual">
                    <div class="mb-3">
                        <label for="date" class="form-label small text-muted text-uppercase fw-bold">Tanggal
                            Prediksi</label>
                        <input type="date" class="form-control" id="date" name="date" required
                            value="{{ request.form.date }}">
                    </div>

                    <h6 class="mt-4 mb-3 text-primary border-bottom pb-2">Konsentrasi Polutan</h6>

                    <div class="row g-2">
                        <div class="col-md-6 mb-3">
                            <label for="pm_sepuluh" class="form-label small text-muted">PM10</label>
                            <input type="number" step="0.01" class="form-control" id="pm_sepuluh" name="pm_sepuluh"
                                required value="{{ request.form.pm_sepuluh }}" placeholder="0.00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sulfur_dioksida" class="form-label small text-muted">SO2 (Sulfur
                                Dioksida)</label>
                            <input type="number" step="0.01" class="form-control" id="sulfur_dioksida"
                                name="sulfur_dioksida" required value="{{ request.form.sulfur_dioksida }}"
                                placeholder="0.00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="karbon_monoksida" class="form-label small text-muted">CO (Karbon
                                Monoksida)</label>
                            <input type="number" step="0.01" class="form-control" id="karbon_monoksida"
                                name="karbon_monoksida" required value="{{ request.form.karbon_monoksida }}"
                                placeholder="0.00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ozon" class="form-label small text-muted">O3 (Ozon)</label>
                            <input type="number" step="0.01" class="form-control" id="ozon" name="ozon" required
                                value="{{ request.form.ozon }}" placeholder="0.00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="nitrogen_dioksida" class="form-label small text-muted">NO2 (Nitrogen
                                Dioksida)</label>
                            <input type="number" step="0.01" class="form-control" id="nitrogen_dioksida"
                                name="nitrogen_dioksida" required value="{{ request.form.nitrogen_dioksida }}"
                                placeholder="0.00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="max" class="form-label small text-muted">Nilai Max Lainnya</label>
                            <input type="number" step="0.01" class="form-control" id="max" name="max" required
                                value="{{ request.form.max }}" placeholder="0.00">
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-calculator"></i> Hitung Prediksi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Results (if available) -->
    {% if result %}
    <div class="col-md-5">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold">Hasil Prediksi</h6>
            </div>
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h6 class="text-muted text-uppercase mb-1">Estimasi PM2.5</h6>
                <div class="display-4 fw-bold mb-2">{{ "%.2f"|format(result.value) }}</div>
                <div class="small text-muted mb-4">µg/m³</div>

                <div class="mb-4">
                    <span class="badge rounded-pill px-4 py-3 bg-{{ result.badge_color }} fs-6">
                        {{ result.category }}
                    </span>
                </div>

                <div class="alert alert-light border small text-start">
                    <strong>Rekomendasi:</strong><br>
                    {{ result.recommendation }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if error %}
    <div class="col-md-5">
        <div class="alert alert-danger shadow-sm">
            <h5 class="alert-heading h6">Error</h5>
            <p class="mb-0 small">{{ error }}</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
    async function fetchLiveData() {
        const btn = document.querySelector('button[onclick="fetchLiveData()"]');
        const originalText = btn.innerHTML;

        try {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
            btn.disabled = true;

            const response = await fetch('/api/live-data');
            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();

            // Auto-fill fields
            document.getElementById('pm_sepuluh').value = data.pm_sepuluh || 0;
            document.getElementById('sulfur_dioksida').value = data.sulfur_dioksida || 0;
            document.getElementById('karbon_monoksida').value = data.karbon_monoksida || 0;
            document.getElementById('ozon').value = data.ozon || 0;
            document.getElementById('nitrogen_dioksida').value = data.nitrogen_dioksida || 0;
            document.getElementById('max').value = data.max || 0; // Still placeholder

            // Set date today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;

            alert('Data berhasil diambil dari Open-Meteo API!');

        } catch (error) {
            console.error('Error:', error);
            alert('Gagal mengambil data live: ' + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>
{% endblock %}